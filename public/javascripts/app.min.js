var app=angular.module("myApp",["ngRoute","ui.bootstrap","ngAnimate","ngFileUpload","simpleAngularTicker"]);app.config(function(a,b){b.html5Mode(!0),a.when("/login",{templateUrl:"views/login.html",controller:"singleViewModalCtrl"}).when("/admin/btle",{templateUrl:"views/btle.html",controller:"locationCtrl"}).when("/admin/diary",{templateUrl:"views/diary.html",controller:"locationCtrl"}).when("/priv_uk",{templateUrl:"views/priv_en.html",controller:"privCtrl"}).when("/priv_dk",{templateUrl:"views/priv_da.html",controller:"privCtrl"}).when("/public",{templateUrl:"views/public.html",controller:"publicCtrl"}).otherwise({redirectTo:"/login"})}),app.run(["loadServices","$rootScope",function(a,b){b.tickers={Allan:[{headline:"",copy:"",created_str:""}],Fiona:[{headline:"",copy:"",created_str:""}]},a.getBios(),a.getTickers(),a.getProjects()}]),app.filter("capInitial",function(){return function(a){var b,c=[],d=[];return"string"==typeof a&&(a=a.toLowerCase(),d=a.split(",")),"object"==typeof a&&(d=a),d.forEach(function(a,b){a=a.trim();for(var d=[],e="",f=0;f<=a.length;f++)d.push(a[f]);e=d[0].toUpperCase(),d.shift(),d.unshift(e),a=d.join(""),c.push(a)}),b=c.length>1?c.join(","):c.toString()}}),app.controller("acctsCtrl",["accountServices","$scope","appServices","$http",function(a,b,c,d){b.acct=[{name:"<<select acct_type>>",value:null},{name:"Private",value:"private"},{name:"Public",value:"public"},{name:"Admin",value:"admin"},{name:"Superuser",value:"superuser"}],b.lang=[{name:"<<select language>>",value:null},{name:"English",value:"en"},{name:"Danish",value:"da"}],b.addAcct=function(){a.addAcct(this.form),c.selectTab("list")},b.viewAcct=function(b,c){a.viewAcct(this.form.acct_type)},b.delAcct=function(){a.deleteAcct(this.user)}}]),app.controller("AddTagsModalCtrl",["imageServices","capInitialFilter","$scope","$modalInstance","$http","$rootScope","appServices",function(a,b,c,d,e,f,g){c.submit=function(){for(var c in this.img)"url"!==c&&"folder"!==c&&"path"!==c&&"file"!==c&&"owner"!==c&&"size"!==c&&"created"!==c&&"year"!==c&&"month"!==c&&"day"!==c&&("city"===c||"state"===c||"names"===c?f.img[c]=b(this.img[c]):f.img[c]=this.img[c]);a.addTags(f.img),d.dismiss("cancel")},c.cancel=function(){f.img={},d.dismiss("cancel")}}]),app.controller("imageCtrl",["storageServices","eventServices","imageServices","$scope","$rootScope","$http","Upload","$timeout","$location","$interval","appServices",function(a,b,c,d,e,f,g,h,i,j,k){k.update_files(),c.getUncategorisedImg(),c.getAll(),d.update_images=function(){var a=j(function(){f.get("/image_jobs/files").then(function(b){b.data.forEach(function(b,c,d){if("zzz"===b)j.cancel(a);else{var e={};e.file=b;var g=h(function(){f.post("/image_jobs/load",e).then(function(a){k.getUncategorisedImg()}),h.cancel(g)},750)}})})},1e4)};document.getElementsByClassName("collapse");e.img={},e.event_form={},d.deleteStorage=function(){a.deleteStorage(this.storage.folder)},d.addEvent=function(){e.event_form.img_id=e.img.id,e.event_form.updated=new Date,b.postEvent(e.event_form),e.event_form={},e.f={}},d.getEventById=function(a,f){e.event_form={},f?d.select("event"):c.getImgById(a),b.getEventById(a)},d.updateEvent=function(){b.updateEvent(e.event_form)}}]),app.controller("indexCtrl",["$location","$http","$rootScope","$scope","$global","getGlobals",function(a,b,c,d,e,f){switch(a.$$hash){case"about_allan":angular.element(document.getElementsByClassName("content-section-b allan")).css("border-bottom","0px"),angular.element(document.getElementsByClassName("fiona")).addClass("ng-hide");break;case"about_fiona":angular.element(document.getElementsByClassName("allan")).addClass("ng-hide");break;default:a.path("/login")}}]),app.controller("landingPageCtrl",["$scope","$http","$rootScope","appServices","landingPageServices",function(a,b,c,d,e){a.postItem=function(){null===this.form.date&&(this.form.date=new Date),this.form.date_str=this.form.date.toDateString(),e.postTicker(this.form),a.form={}},a.postProject=function(){c.load=void 0,e.postProject(this.form),a.form={}},a.getBio=function(){e.getBio(this.form.owner),a.form=c.subjects[this.form.owner]},a.addBio=function(){e.postBio(this.form),a.form={}},a.owners=[{name:"Allan",value:"Allan"},{name:"Fiona",value:"Fiona"}]}]),app.controller("locationCtrl",["$scope","$rootScope","$location","appServices",function(a,b,c,d){var e=document.getElementsByClassName("collapse");b.template={},a.templates={accounts:"./views/accounts.html",images:"./views/images.html",landing:"./views/landing-page.html"},a["switch"]=function(c){b.template.url=a.templates[c],angular.element(e).collapse("hide")},a.setLocation=function(a){"btle"===a&&c.path("/admin/btle"),"diary"===a&&c.path("/admin/diary")},a.select=function(a){d.selectTab(a)}}]),app.controller("LoginModalCtrl",function(a,b,c,d,e,f,g){e.new_files={},a.submit=function(){c.post("/login/authenticate",a.form).then(function(a){"admin"===a.data.acct_type?(g.getStorages(),e.default_storage=a.data.storages[0],d.path("/admin/diary")):"private"===a.data.acct_type&&"en"===a.data.lang?(e.storages=a.data.storages,e.default_storage=e.storages[0],d.path("/priv_uk")):"private"===a.data.acct_type&&"da"===a.data.lang?(e.storages=a.data.storages,e.default_storage=e.storages[0],d.path("/priv_dk")):"public"===a.data.acct_type?d.path("/public"):d.path("/login")}),b.dismiss("cancel")},a.cancel=function(){b.dismiss("cancel")}}),app.controller("logoutCtrl",function(a,b,c){a.logout=function(){c.get("/logout").then(function(a){b.path("/login")})}}),app.controller("ModalInstanceCtrl2",function(a,b,c,d,e){a.selector=0,a.events=c,a.selected={event:a.events[a.selector]},a.cancel=function(){b.dismiss("cancel")},a.play=function(){var b=document.getElementById("play");angular.element(b).hasClass("fa-play")?(angular.element(b).addClass("fa-pause").removeClass("fa-play"),a.interval=e(function(){a.next()},5e3)):angular.element(b).hasClass("fa-pause")&&(angular.element(b).addClass("fa-play").removeClass("fa-pause"),e.cancel(a.interval))},a.next=function(){a.selector<c.length-1?a.selector++:a.selector=0,a.selected={event:a.events[a.selector]}},a.previous=function(){0===a.selector?a.selector=c.length-1:a.selector--,a.selected={event:a.events[a.selector]}}}),app.controller("ModalInstanceCtrl",function(a,b,c){c.get("/queries/latest").then(function(b){a.event=b.data}),a.cancel=function(){b.dismiss("cancel")}}),app.controller("ModifyAcctModalCtrl",function(a,b,c,d){d.getStorages(),a.submit=function(d){void 0!==d?(this.user.option=d,c.put("/accounts_mgmt/modify_storage",this.user).then(function(b){a.viewAcct(b.config.data.acct_type)}),b.dismiss("cancel")):(this.user.new_password===a.user.confirm_password?c.put("/accounts_mgmt/chg",a.user).then(function(a){var b=document.getElementById("alerts");angular.element(b).html(a.data)}):angular.element(document.getElementById("alerts")).html("password mismatch"),b.dismiss("cancel"))},a.cancel=function(){b.dismiss("cancel")}}),app.controller("ModifyStorageModalCtrl",function(a,b,c,d,e,f){a.submit=function(a){"add"===a&&f.addStorage(this.storage),"modify"===a&&f.modifyStorage(this.storage),b.dismiss("cancel")},a.cancel=function(){b.dismiss("cancel")}}),app.controller("multiViewModalCtrl",function(a,b,c,d,e){a.animationsEnabled=!0,a.open2=function(f,g,h){var i={},j=[];void 0!==e.getConditions()&&(j=e.getConditions().split(" ")),"meta"===h&&void 0!==j[0]?"select"!==j[0].toLowerCase()?i.query="select id, path || folder || '/' || file as url from (select * from images where meta is not null "+e.getConditions()+") as x cross join storages where folder = x.storage order by created asc":(i.query="select id, path || folder || '/' || file as url from ("+e.getConditions()+") as x cross join storages where folder = x.storage order by created asc",i.query=i.query.replace(/COLUMN/g,"*")):(a.form.database=g,i=a.form);c.post("/queries",i).then(function(a){b.events=a.data}).then(function(){d.open({animation:a.animationsEnabled,templateUrl:"myModalContent2.html",controller:"ModalInstanceCtrl2",size:f,resolve:{events:function(){return b.events}}})}),a.clear()},a.getValues=function(b,d){"month"===b&&(a.form.option=!1,a.form.day=!1,a.form.month=!1),a.query={},a.query=a.form,a.query.option=b,a.query.database=d,c.post("/dropdowns/build",a.query).then(function(b){void 0!==b.data[0].da&&(a.months=b.data),void 0!==b.data[0].day&&(a.days=b.data)})},a.clear=function(){a.form={},a.form.type_and=!0,a.form.type_or=!1,a.form.exclude=!1,e.resetSQ(),e.buildMeta()}}),app.controller("privCtrl",["$scope","$rootScope","$http","$log","$modal","$location","appServices",function(a,b,c,d,e,f,g){function h(a){c.get("/image_jobs/count/"+a).then(function(a){b.img_db=a.data})}g.resetSQ(),a.selected_db=b.default_storage,h(a.selected_db),a.setActive=function(){h(a.selected_db)},a.years={},a.days={},a.months={};var i=document.getElementsByClassName("collapse");angular.element(i).collapse("hide"),a.select=function(b){g.selectTab(b),"event"===b&&c.get("/images_mgmt/get_all").then(function(b){a.images=b.data}),"meta"===b&&(a.form.type_and=!0,g.buildMeta())},a.selectTable=function(b){a.form={},angular.element(i).collapse("hide"),a.selection=b,a.query={},a.query.option="year",a.query.database=b,c.post("/dropdowns/build",a.query).then(function(b){a.years=b.data})},a.build_query=function(a){var c={};null!==this.form[a]&&void 0!==this.form[a]&&(0===Object.keys(b.baseline).length?(b.baseline[a]=this.form[a],this.form.exclude&&(b.baseline_type="exclude")):(this.form.type_and&&null!==this.form[a]&&(c.contract={},c.contract[a]=this.form[a]),this.form.type_or&&null!==this.form[a]&&(c.expand={},c.expand[a]=this.form[a]),this.form.exclude&&null!==this.form[a]&&(c.exclude={},c.exclude[a]=this.form[a])),c.baseline=b.baseline,void 0===b.search_terms.contract[a]&&this.form.type_and||void 0===b.search_terms.expand[a]&&this.form.type_or||void 0===b.search_terms.exclude[a]&&this.form.exclude?(this.form.type_and&&null!==this.form[a]&&(b.search_terms.contract[a]=[],b.search_terms.contract[a].push(this.form[a])),this.form.type_or&&null!==this.form[a]&&(b.search_terms.expand[a]=[],b.search_terms.expand[a].push(this.form[a])),this.form.exclude&&null!==this.form[a]&&(b.search_terms.exclude[a]=[],b.search_terms.exclude[a].push(this.form[a]))):(this.form.type_and&&null!==this.form[a]&&b.search_terms.contract[a].push(this.form[a]),this.form.type_or&&null!==this.form[a]&&b.search_terms.expand[a].push(this.form[a]),this.form.exclude&&null!==this.form[a]&&b.search_terms.exclude[a].push(this.form[a])),g.buildMeta(c))}}]),app.controller("ResumeModalCtrl",function(a,b,c,d,e){a.cancel=function(){b.dismiss("cancel")}}),app.controller("SaveImgModalCtrl",["imageServices","$scope","$rootScope","$modalInstance","$http","Upload","$timeout",function(a,b,c,d,e,f,g){b.uploadFiles=function(e,h){b.img={},b.img.url=e.name,b.img.meta=b.meta,b.created&&(b.img.created=b.created),c.f=e,e&&!e.$error&&h&&(e.upload=f.upload({url:"/images_mgmt/upload/"+c.default_storage,data:{file:e},method:"PUT"}),e.upload.then(function(a){g(function(){e.result=a.data})},function(a){a.status>0&&(b.errorMsg=a.status+": "+a.data)}),e.upload.progress(function(a){e.progress=Math.min(100,parseInt(100*a.loaded/a.total))})),a.addImg(b.img),d.dismiss("cancel")}}]),app.controller("singleViewModalCtrl",function(a,b,c,d,e,f,g){var h=document.getElementsByClassName("collapse");a.animationsEnabled=!0,a.open=function(b,e,f){var i=g.setModal(e);"event"===e&&angular.element(h).collapse("hide"),"new"===f&&(a.img=this.uncategorized),"Allan"===f&&(a.projects=d.resumes.Allan,a.resume="Allan.txt"),"Fiona"===f&&(a.projects=d.resumes.Fiona,a.resume="Fiona.txt");c.open({scope:a,animation:a.animationsEnabled,templateUrl:i.templ,controller:i.contr,size:b})},a.deleteImg=function(){b["delete"]("/images_mgmt/"+this.uncategorized.id).then(function(a){g.getUncategorisedImg(),g.update_files()})}}),app.service("accountServices",["$http","$rootScope",function(a,b){var c={};return c.addAcct=function(b){a.post("/accounts_mgmt/add",b).then(function(a){c.viewAcct(b.acct_type)})},c.deleteAcct=function(b){a["delete"]("/accounts_mgmt/"+b.username).then(function(a){c.viewAcct(b.acct_type)})},c.viewAcct=function(c){a.get("/accounts_mgmt/"+c).then(function(a){b.users=a.data})},c}]),app.service("eventServices",["$http","$rootScope",function(a,b){var c={};return c.postEvent=function(c){a.post("/events_mgmt/add",c).then(function(a){b.img={}})},c.getEventById=function(c){a.get("/events_mgmt/"+c).then(function(a){b.event_form=a.data})},c.updateEvent=function(c){a.put("/events_mgmt",c).then(function(a){b.event_form={},b.img={}})},c}]),app.factory("appServices",["$http","$rootScope",function(a,b){var c,d,e={},f={meta:"meta_div",time:"time_div",list:"list_div",add:"add_div",image:"image_div",event:"event_div",storage:"storage_div",resume:"resume_div",ticker:"ticker_div",biography:"biography_div"},g={login:{contr:"LoginModalCtrl",templ:"loginModal.html"},modify:{contr:"ModifyAcctModalCtrl",templ:"changePWModal.html"},resume:{contr:"ResumeModalCtrl",templ:"resumeModal.html"},file:{contr:"SaveImgModalCtrl",templ:"saveImgModal.html"},meta:{contr:"AddTagsModalCtrl",templ:"addTagsModal.html"},storage:{contr:"ModifyAcctModalCtrl",templ:"manageStoragesModal.html"},modify_storage:{contr:"ModifyStorageModalCtrl",templ:"modifyStorageModal.html"},add_storage:{contr:"ModifyStorageModalCtrl",templ:"addStorageModal.html"},event:{contr:"ModalInstanceCtrl",templ:"myModalContent.html"}};return e.setModal=function(a){return g[a]},e.buildMeta=function(e){var f,g,h,i=Object.keys(b.baseline).toString();for(var j in e)"baseline"!==j&&(f=Object.keys(e[j]).toString(),g=j,h=e[j]);switch(g){case"contract":d+="names"!==f&&"meta"!==f?" AND "+Object.keys(h).toString()+" = xxx"+h[Object.keys(h).toString()]+"xxx":" AND xxx"+h[Object.keys(h).toString()]+"xxx = ANY("+Object.keys(h).toString()+")";break;case"expand":d+="names"!==f&&"meta"!==f?" OR "+Object.keys(h).toString()+" = xxx"+h[Object.keys(h).toString()]+"xxx":" OR xxx"+h[Object.keys(h).toString()]+"xxx = ANY("+Object.keys(h).toString()+")";break;case"exclude":"names"!==f&&"meta"!==f&&1>c?(d="SELECT DISTINCT RES"+c+".COLUMN FROM (SELECT * FROM IMAGES WHERE META IS NOT NULL "+d+") AS RES"+c+" WHERE "+f+" != xxx"+h[f]+"xxx",c++,b.exlc_incr++):(d=d.replace(/RES\w.COLUMN/g,"ASTERIX"),d="SELECT DISTINCT RES"+c+".* FROM ("+d+") as RES"+c+" where "+f+" != xxx"+h[f]+"xxx",c++);break;case void 0:"exclude"===b.baseline_type?d=" AND "+i+" != xxx"+b.baseline[i]+"xxx":"names"===i||"meta"===i?d=" AND xxx"+b.baseline[i]+"xxx = ANY("+i+")":i&&(d=" AND "+i+" = xxx"+b.baseline[i]+"xxx")}a.get("/dropdowns/"+d).then(function(a){b.meta=a.data}),a.put("/queries/count",{conditions:d}).then(function(a){b.queries_count=a.data[0].count})},e.selectTab=function(a){for(var b in f)b!==a?(angular.element(document.getElementById(b)).removeClass("active"),angular.element(document.getElementById(f[b])).addClass("ng-hide")):(angular.element(document.getElementById(b)).addClass("active"),angular.element(document.getElementById(f[b])).removeClass("ng-hide"))},e.resetSQ=function(){b.baseline={},b.baseline_type="",b.queries_count="",b.search_terms={},b.search_terms.contract={},b.search_terms.expand={},b.search_terms.exclude={},d=void 0,c=0,b.exlc_incr=0},e.getConditions=function(){return d},e.update_files=function(){var c=document.getElementById("new_files"),d="ng-show";a.get("/image_jobs/count/"+b.default_storage).then(function(e){b.img_db=e.data,a.get("/image_jobs/new_files/").then(function(a){parseInt(a.data.amount)>parseInt(b.img_db.size)&&(angular.element(c).removeClass("ng-hide"),angular.element(c).addClass(d))})})},e}]),app.factory("getGlobals",["$global",function(a){var b=a.request;return{tickers:function(){return b(a.url("tickers"))},biographies:function(){return b(a.url("biographies"))},resumes:function(){return b(a.url("resumes"))}}}]),app.factory("$global",["$http",function(a){var b={biographies:"/landing_mgmt/bios/all",tickers:"/landing_mgmt/tickers",resumes:"/landing_mgmt/projects"},c={},d={},e={},f={};return f.request=function(b){return a.get(b)},f.url=function(a){return b[a]},f.setBiographies=function(a){c=a},f.getBiographies=function(){return c},f.setTickers=function(a){d=a},f.getTickers=function(){return d},f.setResumes=function(a){e=a},f.getResumes=function(){return e},f}]),app.service("imageServices",["$http","$rootScope","appServices",function(a,b,c){var d={};return d.getAll=function(){a.get("/images_mgmt/get_all").then(function(a){b.images=a.data})},d.getLatest=function(){a.get("/images_mgmt/get_latest").then(function(a){b.img=a.data})},d.addImg=function(b){a.post("/images_mgmt/add",b).then(function(a){d.getLatest()}).then(function(a){d.getAll()})},d.addTags=function(b){a.put("/images_mgmt/add_meta",b).then(function(a){d.getUncategorisedImg("add tags")})},d.getUncategorisedImg=function(){a.get("/images_mgmt/get_new").then(function(a){b.uncategorized=a.data})},d.getImgById=function(c){a.get("/images_mgmt/get_one/"+c).then(function(a){b.img=a.data})},d}]),app.service("landingPageServices",["$http","loadServices",function(a,b){this.postTicker=function(c){a.post("/landing_mgmt/tickers",c).then(function(a){b.getTickers()})},this.postProject=function(c){a.post("/landing_mgmt/projects",c).then(function(a){b.getProjects()})},this.postBio=function(c){a.put("/landing_mgmt/bios",c).then(function(a){b.getBios()})},this.getBio=function(a){b.getBios()}}]),app.service("loadServices",["$http","$rootScope",function(a,b){this.getBios=function(){a.get("landing_mgmt/bios/all").then(function(a){b.subjects=a.data})},this.getTickers=function(){a.get("/landing_mgmt/tickers").then(function(a){b.tickers=a.data})},this.getProjects=function(){a.get("/landing_mgmt/projects").then(function(a){b.resumes=a.data})}}]),app.service("storageServices",["$http","$rootScope",function(a,b){var c={};return c.addStorage=function(b){a.post("/storages_mgmt/add",b).then(function(a){c.getStorages()})},c.deleteStorage=function(b){a["delete"]("/storages_mgmt/"+b).then(function(a){c.getStorages()})},c.getStorages=function(){a.get("/storages_mgmt/all").then(function(a){b.storages=a.data})},c.modifyStorage=function(b){a.put("/storages_mgmt/update",b).then(function(a){c.getStorages()})},c}]),app.directive("insertBio",function(){return{restrict:"EA",scope:{subject:"="},templateUrl:"views/biography.html"}}),app.directive("latestEventModal",function(){return{restrict:"EA",templateUrl:"views/latestEvent.html"}}),app.directive("multiViewModal",function(){return{restrict:"EA",templateUrl:"views/multiView.html"}}),app.directive("myResumeModal",function(){return{restrict:"EA",templateUrl:"views/resume.html"}});