var app=angular.module("myApp",["ngRoute","ui.bootstrap","ngAnimate","ngFileUpload","simpleAngularTicker"]);app.config(function(a,b){b.html5Mode(!0),a.when("/login",{templateUrl:"views/login.html",controller:"singleViewModalCtrl"}).when("/admin/diary",{templateUrl:"views/diary.html",controller:"switchCtrl"}).when("/priv_uk",{templateUrl:"views/priv_en.html",controller:"privCtrl"}).when("/priv_dk",{templateUrl:"views/priv_da.html",controller:"privCtrl"}).when("/public",{templateUrl:"views/public.html",controller:"publicCtrl"}).otherwise({redirectTo:"/login"})}),app.filter("capInitial",function(){return function(a){var b,c=[];a=a.toLowerCase();var d=a.split(",");return d.forEach(function(a,b){a=a.trim();for(var d=[],e="",f=0;f<=a.length;f++)d.push(a[f]);e=d[0].toUpperCase(),d.shift(),d.unshift(e),a=d.join(""),c.push(a)}),b=c.length>1?c.join(","):c.toString()}}),app.controller("indexCtrl",function(a,b,c,d){function e(){b.get("landing_mgmt/bios/all").then(function(a){c.subjects=a.data})}function f(){b.get("/landing_mgmt/tickers").then(function(a){c.tickers=a.data})}function g(){b.get("/landing_mgmt/projects").then(function(a){c.resumes=a.data})}switch(void 0===c.load&&(c.tickers={Allan:[{headline:"",copy:"",created_str:""}],Fiona:[{headline:"",copy:"",created_str:""}]},c.load=!0),e(),f(),g(),a.$$hash){case"about_allan":angular.element(document.getElementsByClassName("content-section-b allan")).css("border-bottom","0px"),angular.element(document.getElementsByClassName("fiona")).addClass("ng-hide");break;case"about_fiona":angular.element(document.getElementsByClassName("allan")).addClass("ng-hide");break;default:a.path("/login")}}),app.controller("switchCtrl",function(a,b){var c=document.getElementsByClassName("collapse");b.template={},a.templates={accounts:"./views/accounts.html",images:"./views/images.html",landing:"./views/landing-page.html"},a["switch"]=function(d){b.template.url=a.templates[d],angular.element(c).collapse("hide")}}),app.controller("imageCtrl",["$scope","$rootScope","$http","Upload","$timeout","$location","$interval","appServices",function(a,b,c,d,e,f,g,h){h.update_files(),h.getUncategorisedImg(),a.update_images=function(){var a=g(function(){c.get("/image_jobs/files").then(function(b){b.data.forEach(function(b,d,f){if("zzz"===b)g.cancel(a);else{var i={};i.file=b;var j=e(function(){c.post("/image_jobs/load",i).then(function(a){h.getUncategorisedImg()}),e.cancel(j)},750)}})})},1e4)};document.getElementsByClassName("collapse");b.img={},b.event_form={},a.setLocation=function(a){"btle"===a&&f.path("/admin/btle"),"diary"===a&&f.path("/admin/diary")},a.select=function(a){h.selectTab(a)},a.addStorage=function(){c.post("/storages_mgmt/add",this.form).then(function(a){})},a.deleteStorage=function(){c.put("/storages_mgmt/delete",this.storage).then(function(a){h.getStorages()})},a.addEvent=function(){this.form=b.event_form,this.form.url=b.img.url,this.form.meta=b.img.meta,this.form.img_id=b.img.id||this.selected_id,this.form.updated=new Date,c.post("/events_mgmt/add",this.form).then(function(a){}),this.form={},b.event_form={},b.img={},b.f={}},a.getEventById=function(d,e){e?a.select("event"):c.get("/images_mgmt/get_one/"+d).then(function(a){b.img=a.data[0]});var f=d;c.get("/events_mgmt/"+f).then(function(a){0!==a.data.length?b.event_form=a.data[0]:b.event_form={}})},a.updateEvent=function(){c.put("/events_mgmt",b.event_form).then(function(a){}),b.event_form={},b.img={}}}]),app.controller("acctsCtrl",["$scope","appServices","$http",function(a,b,c){a.select=function(a){b.selectTab(a)},a.addAcct=function(){var d=this.form.acct_type;c.post("/accounts_mgmt/add",this.form).then(function(c){a.viewAcct(d,"list"),a.form={},b.selectTab("list")})},a.viewAcct=function(b,d){var e=b||this.form.acct_type;c.get("/accounts_mgmt/"+e).then(function(b){a.users=b.data})},a.delAcct=function(){var b=this.user.acct_type;c["delete"]("/accounts_mgmt/"+this.user.username).then(function(c){a.viewAcct(b)})},a.acct=[{name:"select acct_type",value:null},{name:"Private",value:"private"},{name:"Public",value:"public"},{name:"Admin",value:"admin"},{name:"Superuser",value:"superuser"}],a.speak=[{name:"English",value:"en"},{name:"Danish",value:"da"}]}]),app.controller("landingPageCtrl",["$scope","$http","$rootScope","appServices",function(a,b,c,d){a.select=function(a){d.selectTab(a)},a.postItem=function(){c.load=void 0,null===this.form.date&&(this.form.date=new Date),this.form.date_str=this.form.date.toDateString(),b.post("/landing_mgmt/tickers",this.form).then(function(b){a.form={}})},a.postProject=function(){c.load=void 0,b.post("/landing_mgmt/projects",this.form).then(function(b){a.form={}})},a.getBio=function(){b.get("/landing_mgmt/bios/"+this.form.owner).then(function(b){a.form=b.data})},a.addBio=function(){c.load=void 0,b.put("/landing_mgmt/bios",this.form).then(function(b){a.form={}})},a.owners=[{name:"Allan",value:"Allan"},{name:"Fiona",value:"Fiona"}]}]),app.controller("privCtrl",["$scope","$rootScope","$http","$log","$modal","$location","appServices",function(a,b,c,d,e,f,g){function h(a){c.get("/image_jobs/count/"+a).then(function(a){b.img_db=a.data})}g.resetSQ(),a.selected_db=b.default_storage,h(a.selected_db),a.setActive=function(){h(a.selected_db)},a.years={},a.days={},a.months={};var i=document.getElementsByClassName("collapse");angular.element(i).collapse("hide"),a.select=function(b){g.selectTab(b),"event"===b&&c.get("/images_mgmt/get_all").then(function(b){a.images=b.data}),"meta"===b&&(a.form.type_and=!0,g.buildMeta())},a.selectTable=function(b){a.form={},angular.element(i).collapse("hide"),a.selection=b,a.query={},a.query.option="year",a.query.database=b,c.post("/dropdowns/build",a.query).then(function(b){a.years=b.data})},a.build_query=function(a){var c={};null!==this.form[a]&&void 0!==this.form[a]&&(0===Object.keys(b.baseline).length?(b.baseline[a]=this.form[a],this.form.exclude&&(b.baseline_type="exclude")):(this.form.type_and&&null!==this.form[a]&&(c.contract={},c.contract[a]=this.form[a]),this.form.type_or&&null!==this.form[a]&&(c.expand={},c.expand[a]=this.form[a]),this.form.exclude&&null!==this.form[a]&&(c.exclude={},c.exclude[a]=this.form[a])),c.baseline=b.baseline,void 0===b.search_terms.contract[a]&&this.form.type_and||void 0===b.search_terms.expand[a]&&this.form.type_or||void 0===b.search_terms.exclude[a]&&this.form.exclude?(this.form.type_and&&null!==this.form[a]&&(b.search_terms.contract[a]=[],b.search_terms.contract[a].push(this.form[a])),this.form.type_or&&null!==this.form[a]&&(b.search_terms.expand[a]=[],b.search_terms.expand[a].push(this.form[a])),this.form.exclude&&null!==this.form[a]&&(b.search_terms.exclude[a]=[],b.search_terms.exclude[a].push(this.form[a]))):(this.form.type_and&&null!==this.form[a]&&b.search_terms.contract[a].push(this.form[a]),this.form.type_or&&null!==this.form[a]&&b.search_terms.expand[a].push(this.form[a]),this.form.exclude&&null!==this.form[a]&&b.search_terms.exclude[a].push(this.form[a])),g.buildMeta(c))}}]),app.controller("logoutCtrl",function(a,b,c){a.logout=function(){c.get("/logout").then(function(a){b.path("/login")})}}),app.controller("singleViewModalCtrl",function(a,b,c,d,e,f,g){var h=document.getElementsByClassName("collapse");a.animationsEnabled=!0,a.open=function(b,e,f){var i=g.setModal(e);"event"===e&&angular.element(h).collapse("hide"),"new"===f&&(a.img=this.uncategorized),"Allan"===f&&(a.projects=d.resumes.Allan,a.resume="Allan.txt"),"Fiona"===f&&(a.projects=d.resumes.Fiona,a.resume="Fiona.txt");c.open({scope:a,animation:a.animationsEnabled,templateUrl:i.templ,controller:i.contr,size:b})},a.deleteImg=function(){b["delete"]("/images_mgmt/"+this.uncategorized.id).then(function(a){g.getUncategorisedImg(),g.update_files()})}}),app.controller("ModalInstanceCtrl",function(a,b,c){c.get("/queries/latest").then(function(b){a.event=b.data}),a.cancel=function(){b.dismiss("cancel")}}),app.controller("multiViewModalCtrl",function(a,b,c,d,e){a.animationsEnabled=!0,a.open2=function(f,g,h){var i={},j=[];void 0!==e.getConditions()&&(j=e.getConditions().split(" ")),"meta"===h&&void 0!==j[0]?"select"!==j[0].toLowerCase()?i.query="select id, path || folder || '/' || file as url from (select * from images where meta is not null "+e.getConditions()+") as x cross join storages where folder = x.storage order by created asc":(i.query="select id, path || folder || '/' || file as url from ("+e.getConditions()+") as x cross join storages where folder = x.storage order by created asc",i.query=i.query.replace(/COLUMN/g,"*")):(a.form.database=g,i=a.form);c.post("/queries",i).then(function(a){b.events=a.data}).then(function(){d.open({animation:a.animationsEnabled,templateUrl:"myModalContent2.html",controller:"ModalInstanceCtrl2",size:f,resolve:{events:function(){return b.events}}})}),a.clear()},a.getValues=function(b,d){"month"===b&&(a.form.option=!1,a.form.day=!1,a.form.month=!1),a.query={},a.query=a.form,a.query.option=b,a.query.database=d,c.post("/dropdowns/build",a.query).then(function(b){void 0!==b.data[0].da&&(a.months=b.data),void 0!==b.data[0].day&&(a.days=b.data)})},a.clear=function(){a.form={},a.form.type_and=!0,a.form.type_or=!1,a.form.exclude=!1,e.resetSQ(),e.buildMeta()}}),app.controller("ModalInstanceCtrl2",function(a,b,c,d,e){a.selector=0,a.events=c,a.selected={event:a.events[a.selector]},a.cancel=function(){b.dismiss("cancel")},a.play=function(){var b=document.getElementById("play");angular.element(b).hasClass("fa-play")?(angular.element(b).addClass("fa-pause").removeClass("fa-play"),a.interval=e(function(){a.next()},5e3)):angular.element(b).hasClass("fa-pause")&&(angular.element(b).addClass("fa-play").removeClass("fa-pause"),e.cancel(a.interval))},a.next=function(){a.selector<c.length-1?a.selector++:a.selector=0,a.selected={event:a.events[a.selector]}},a.previous=function(){0===a.selector?a.selector=c.length-1:a.selector--,a.selected={event:a.events[a.selector]}}}),app.controller("LoginModalCtrl",function(a,b,c,d,e,f){e.new_files={},a.submit=function(){c.post("/login/authenticate",a.form).then(function(a){"admin"===a.data.acct_type?(f.getStorages(),e.default_storage=a.data.storages[0],d.path("/admin/diary")):"private"===a.data.acct_type&&"en"===a.data.lang?(e.storages=a.data.storages,e.default_storage=e.storages[0],d.path("/priv_uk")):"private"===a.data.acct_type&&"da"===a.data.lang?(e.storages=a.data.storages,e.default_storage=e.storages[0],d.path("/priv_dk")):"public"===a.data.acct_type?d.path("/public"):d.path("/login")}),b.dismiss("cancel")},a.cancel=function(){b.dismiss("cancel")}}),app.controller("ResumeModalCtrl",function(a,b,c,d,e){a.cancel=function(){b.dismiss("cancel")}}),app.controller("SaveImgModalCtrl",function(a,b,c,d,e,f){a.uploadFiles=function(g,h){a.img={},a.img.url=g.name,a.img.meta=a.meta,a.created&&(a.img.created=a.created),b.f=g,g&&!g.$error&&h&&(g.upload=e.upload({url:"/images_mgmt/upload/"+b.default_storage,data:{file:g},method:"PUT"}),g.upload.then(function(a){f(function(){g.result=a.data})},function(b){b.status>0&&(a.errorMsg=b.status+": "+b.data)}),g.upload.progress(function(a){g.progress=Math.min(100,parseInt(100*a.loaded/a.total))})),d.post("/images_mgmt/add",a.img).then(function(c){d.get("/images_mgmt/get_latest").then(function(c){b.img=c.data[0],d.get("/images_mgmt/get_all").then(function(b){a.images=b.data})})}),c.dismiss("cancel")}}),app.controller("AddTagsModalCtrl",["capInitialFilter","$scope","$modalInstance","$http","$rootScope","appServices",function(a,b,c,d,e,f){b.submit=function(){for(var b in this.img)"url"!==b&&"folder"!==b&&"path"!==b&&"file"!==b&&"owner"!==b&&"size"!==b&&"created"!==b&&"year"!==b&&"month"!==b&&"day"!==b&&("city"===b||"state"===b||"names"===b?e.img[b]=a(this.img[b]):e.img[b]=this.img[b]);d.put("/images_mgmt/add_meta",e.img).then(function(a){f.getUncategorisedImg("add tags")}),e.img={},c.dismiss("cancel")},b.cancel=function(){e.img={},c.dismiss("cancel")}}]),app.controller("ModifyStorageModalCtrl",function(a,b,c,d,e){a.submit=function(d){"add"===d&&c.post("/storages_mgmt/add",a.storage).then(function(a){e.getStorages()}),"modify"===d&&c.put("/storages_mgmt/update",this.storage).then(function(a){e.getStorages()}),b.dismiss("cancel")},a.cancel=function(){b.dismiss("cancel")}}),app.controller("ModifyAcctModalCtrl",function(a,b,c,d){d.getStorages(),a.submit=function(d){void 0!==d?(this.user.option=d,c.put("/accounts_mgmt/modify_storage",this.user).then(function(b){a.viewAcct(b.config.data.acct_type)}),b.dismiss("cancel")):(this.user.new_password===a.user.confirm_password?c.put("/accounts_mgmt/chg",a.user).then(function(a){var b=document.getElementById("alerts");angular.element(b).html(a.data)}):angular.element(document.getElementById("alerts")).html("password mismatch"),b.dismiss("cancel"))},a.cancel=function(){b.dismiss("cancel")}}),app.factory("appServices",["$http","$rootScope",function(a,b){var c,d,e={},f={meta:"meta_div",time:"time_div",list:"list_div",add:"add_div",image:"image_div",event:"event_div",storage:"storage_div",resume:"resume_div",ticker:"ticker_div",biography:"biography_div"},g={login:{contr:"LoginModalCtrl",templ:"loginModal.html"},modify:{contr:"ModifyAcctModalCtrl",templ:"changePWModal.html"},resume:{contr:"ResumeModalCtrl",templ:"resumeModal.html"},file:{contr:"SaveImgModalCtrl",templ:"saveImgModal.html"},meta:{contr:"AddTagsModalCtrl",templ:"addTagsModal.html"},storage:{contr:"ModifyAcctModalCtrl",templ:"manageStoragesModal.html"},modify_storage:{contr:"ModifyStorageModalCtrl",templ:"modifyStorageModal.html"},add_storage:{contr:"ModifyStorageModalCtrl",templ:"addStorageModal.html"},event:{contr:"ModalInstanceCtrl",templ:"myModalContent.html"}};return e.getStorages=function(){a.get("/storages_mgmt/all").then(function(a){b.storages=a.data})},e.setModal=function(a){return g[a]},e.buildMeta=function(e){var f,g,h,i=Object.keys(b.baseline).toString();for(var j in e)"baseline"!==j&&(f=Object.keys(e[j]).toString(),g=j,h=e[j]);switch(g){case"contract":d+="names"!==f&&"meta"!==f?" AND "+Object.keys(h).toString()+" = xxx"+h[Object.keys(h).toString()]+"xxx":" AND xxx"+h[Object.keys(h).toString()]+"xxx = ANY("+Object.keys(h).toString()+")";break;case"expand":d+="names"!==f&&"meta"!==f?" OR "+Object.keys(h).toString()+" = xxx"+h[Object.keys(h).toString()]+"xxx":" OR xxx"+h[Object.keys(h).toString()]+"xxx = ANY("+Object.keys(h).toString()+")";break;case"exclude":"names"!==f&&"meta"!==f&&1>c?(d="SELECT DISTINCT RES"+c+".COLUMN FROM (SELECT * FROM IMAGES WHERE META IS NOT NULL "+d+") AS RES"+c+" WHERE "+f+" != xxx"+h[f]+"xxx",c++,b.exlc_incr++):(d=d.replace(/RES\w.COLUMN/g,"ASTERIX"),d="SELECT DISTINCT RES"+c+".* FROM ("+d+") as RES"+c+" where "+f+" != xxx"+h[f]+"xxx",c++);break;case void 0:"exclude"===b.baseline_type?d=" AND "+i+" != xxx"+b.baseline[i]+"xxx":"names"===i||"meta"===i?d=" AND xxx"+b.baseline[i]+"xxx = ANY("+i+")":i&&(d=" AND "+i+" = xxx"+b.baseline[i]+"xxx")}a.get("/dropdowns/"+d).then(function(a){b.meta=a.data}),a.put("/queries/count",{conditions:d}).then(function(a){b.queries_count=a.data[0].count})},e.selectTab=function(a){for(var b in f)b!==a?(angular.element(document.getElementById(b)).removeClass("active"),angular.element(document.getElementById(f[b])).addClass("ng-hide")):(angular.element(document.getElementById(b)).addClass("active"),angular.element(document.getElementById(f[b])).removeClass("ng-hide"))},e.resetSQ=function(){b.baseline={},b.baseline_type="",b.queries_count="",b.search_terms={},b.search_terms.contract={},b.search_terms.expand={},b.search_terms.exclude={},d=void 0,c=0,b.exlc_incr=0},e.getConditions=function(){return d},e.getUncategorisedImg=function(c){a.get("/images_mgmt/get_new").then(function(a){b.uncategorized=a.data})},e.update_files=function(){var c=document.getElementById("new_files"),d="ng-show";a.get("/image_jobs/count/"+b.default_storage).then(function(e){b.img_db=e.data,a.get("/image_jobs/new_files/").then(function(a){parseInt(a.data.amount)>parseInt(b.img_db.size)&&(angular.element(c).removeClass("ng-hide"),angular.element(c).addClass(d))})})},e}]),app.directive("insertBio",function(){return{restrict:"EA",scope:{subject:"="},templateUrl:"views/biography.html"}}),app.directive("latestEventModal",function(){return{restrict:"EA",templateUrl:"views/latestEvent.html"}}),app.directive("multiViewModal",function(){return{restrict:"EA",templateUrl:"views/multiView.html"}}),app.directive("myResumeModal",function(){return{restrict:"EA",templateUrl:"views/resume.html"}});